services:
  fava:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fava
    volumes:
      - ./books:/books
    # If you donot use oauth2-proxy, uncomment the following
    # ports: 
    #   - 5000:5000
    environment:
      - BEANCOUNT_FILE=/books/main.bean
    networks:
      - fava-network

  oauth2-proxy-fava:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    container_name: oauth2-proxy
    ports:
      - 5505:5505
    environment:
      # OIDC configuration
      - OAUTH2_PROXY_PROVIDER=oidc
      - OAUTH2_PROXY_OIDC_ISSUER_URL=${OIDC_ISSUER_URL}
      - OAUTH2_PROXY_CLIENT_ID=${OAUTH2_CLIENT_ID}
      - OAUTH2_PROXY_CLIENT_SECRET=${OAUTH2_CLIENT_SECRET}
      - OAUTH2_PROXY_REDIRECT_URL=${OAUTH2_PROXY_REDIRECT_URL}

      # Email domain restriction
      - OAUTH2_PROXY_EMAIL_DOMAINS=${OAUTH2_PROXY_EMAIL_DOMAINS}

      # Cookie configuration
      - OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_PROXY_COOKIE_SECRET}
      - OAUTH2_PROXY_COOKIE_SECURE=true
      - OAUTH2_PROXY_COOKIE_SAMESITE=lax
      - OAUTH2_PROXY_CODE_CHALLENGE_METHOD=S256

      # Upstream configuration
      - OAUTH2_PROXY_UPSTREAMS=http://fava:5000

      # Listening address
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:5505

      # Additional settings
      - OAUTH2_PROXY_SKIP_PROVIDER_BUTTON=false
      - OAUTH2_PROXY_PASS_ACCESS_TOKEN=true
      - OAUTH2_PROXY_PASS_USER_HEADERS=true
    depends_on:
      - fava
    networks:
      - fava-network

networks:
  fava-network:
    driver: bridge
